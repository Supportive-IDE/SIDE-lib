"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.directImport=exports.VariableUsage=exports.Variable=exports.UserDefinedFunction=exports.Module=exports.FunctionUsage=void 0;var _expression=require("./expression.js"),_executionline=require("./executionline.js"),_observers=require("./observers.js"),_block=require("./block.js");function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var a=0,s=function(){};return{s:s,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,n=!0,l=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return n=e.done,e},e:function(e){l=!0,r=e},f:function(){try{n||null==i.return||i.return()}finally{if(l)throw r}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,a=new Array(t);i<t;i++)a[i]=e[i];return a}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var a=_superPropBase(e,t);if(a){var s=Object.getOwnPropertyDescriptor(a,t);return s.get?s.get.call(arguments.length<3?e:i):s.value}},_get.apply(this,arguments)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var i,a=_getPrototypeOf(e);if(t){var s=_getPrototypeOf(this).constructor;i=Reflect.construct(a,arguments,s)}else i=a.apply(this,arguments);return _possibleConstructorReturn(this,i)}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t),t.set(e,i)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}function _classPrivateFieldGet(e,t){return _classApplyDescriptorGet(e,_classExtractFieldDescriptor(e,t,"get"))}function _classApplyDescriptorGet(e,t){return t.get?t.get.call(e):t.value}function _classPrivateFieldSet(e,t,i){return _classApplyDescriptorSet(e,_classExtractFieldDescriptor(e,t,"set"),i),i}function _classExtractFieldDescriptor(e,t,i){if(!t.has(e))throw new TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function _classApplyDescriptorSet(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=i}}var _name=new WeakMap,_executionLines=new WeakMap,_allFunctionCalls=new WeakMap,_parameters=new WeakMap,_optionalCount=new WeakMap,_returnLines=new WeakMap,_aggReturnType=new WeakMap,_exitBlocks=new WeakMap,_hasBranchWithoutReturn=new WeakMap,_allReturnTypesNumeric=new WeakSet,UserDefinedFunction=function(e){_inherits(i,_observers.TypeChangeObserverNotifier);var t=_createSuper(i);function i(e){var a;return _classCallCheck(this,i),_classPrivateMethodInitSpec(_assertThisInitialized(a=t.call(this)),_allReturnTypesNumeric),_classPrivateFieldInitSpec(_assertThisInitialized(a),_name,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_executionLines,{writable:!0,value:[]}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_allFunctionCalls,{writable:!0,value:[]}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_parameters,{writable:!0,value:[]}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_optionalCount,{writable:!0,value:0}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_returnLines,{writable:!0,value:[]}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_aggReturnType,{writable:!0,value:_expression.DataType.None}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_exitBlocks,{writable:!0,value:[]}),_classPrivateFieldInitSpec(_assertThisInitialized(a),_hasBranchWithoutReturn,{writable:!0,value:!1}),_classPrivateFieldSet(_assertThisInitialized(a),_name,e),a}return _createClass(i,[{key:"getName",value:function(){return _classPrivateFieldGet(this,_name)}},{key:"setLines",value:function(e){_classPrivateFieldSet(this,_executionLines,e)}},{key:"addLine",value:function(e){_classPrivateFieldGet(this,_executionLines).push(e)}},{key:"getLines",value:function(){return _classPrivateFieldGet(this,_executionLines)}},{key:"getLinesWithEntity",value:function(e){return _classPrivateFieldGet(this,_executionLines).filter((function(t){return t.indexOfEntity(e)>-1}))}},{key:"addParameter",value:function(e){_classPrivateFieldGet(this,_parameters).push(e)}},{key:"addOptionalParameter",value:function(){var e;_classPrivateFieldSet(this,_optionalCount,(e=_classPrivateFieldGet(this,_optionalCount),e++,e))}},{key:"getParameters",value:function(){return _classPrivateFieldGet(this,_parameters)}},{key:"getNumberOfOptionalParameters",value:function(){return _classPrivateFieldGet(this,_optionalCount)}},{key:"getBlock",value:function(){if(_classPrivateFieldGet(this,_executionLines).length>0)return _classPrivateFieldGet(this,_executionLines)[0].getBlock()}},{key:"addFunctionCall",value:function(e){_classPrivateFieldGet(this,_allFunctionCalls).push(e)}},{key:"addMultipleFunctionCalls",value:function(e){_classPrivateFieldSet(this,_allFunctionCalls,_classPrivateFieldGet(this,_allFunctionCalls).concat(e))}},{key:"addExitBlock",value:function(e){_classPrivateFieldGet(this,_exitBlocks).push(e)}},{key:"addReturnLine",value:function(e){_classPrivateFieldGet(this,_returnLines).push(e),_get(_getPrototypeOf(i.prototype),"sendUpdate",this).call(this,this.getAggregateReturnType())}},{key:"getReturnLines",value:function(){return _classPrivateFieldGet(this,_returnLines)}},{key:"addBranchWithNoReturn",value:function(){_classPrivateFieldSet(this,_hasBranchWithoutReturn,!0),_get(_getPrototypeOf(i.prototype),"sendUpdate",this).call(this,this.getAggregateReturnType())}},{key:"typeUpdateReceived",value:function(e){var t=_classPrivateFieldGet(this,_aggReturnType),a=this.getAggregateReturnType();t!==a&&_get(_getPrototypeOf(i.prototype),"sendUpdate",this).call(this,a)}},{key:"getReturnTypes",value:function(){var e,t=[],i=_createForOfIteratorHelper(_classPrivateFieldGet(this,_returnLines));try{for(i.s();!(e=i.n()).done;){var a=e.value,s=a.indexOfEntity(_expression.ExpressionEntity.ReturnKeyword)>-1;s&&!t.includes(a.getCompoundExpression().getEvaluatedType())?t.push(a.getCompoundExpression().getEvaluatedType()):s||t.includes(_expression.DataType.None)||t.push(_expression.DataType.None)}}catch(e){i.e(e)}finally{i.f()}return _classPrivateFieldGet(this,_hasBranchWithoutReturn)&&!t.includes(_expression.DataType.None)&&t.push(_expression.DataType.None),t}},{key:"getReturnDetail",value:function(){var e,t=[],i=_createForOfIteratorHelper(_classPrivateFieldGet(this,_returnLines));try{for(i.s();!(e=i.n()).done;){var a=e.value;a.indexOfEntity(_expression.ExpressionEntity.ReturnKeyword)>-1&&t.push({line:a.getDocumentLineNumber(),dataType:a.getCompoundExpression().getEvaluatedType()})}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"hasReturn",value:function(){var e=this.getReturnTypes();return e.length>1||1===e.length&&e[0]!==_expression.DataType.None}},{key:"hasReturnInBlock",value:function(e){var t,i=[_expression.ExpressionEntity.IfDefinition,_expression.ExpressionEntity.ElifDefinition,_expression.ExpressionEntity.ElseDefinition,_expression.ExpressionEntity.ForDefinition,_expression.ExpressionEntity.WhileDefinition,_expression.ExpressionEntity.TryDefinition,_expression.ExpressionEntity.ExceptDefinition,_expression.ExpressionEntity.FunctionDefinition],a=_classPrivateFieldGet(this,_returnLines).filter((function(t){return e.hasChild(t.getBlock())})).sort((function(t,i){return t.getBlock().getStepsToParentBlock(e)-i.getBlock().getStepsToParentBlock(e)})),s=_createForOfIteratorHelper(a);try{for(s.s();!(t=s.n()).done;){var r=t.value.getBlock(),n=r.getStepsToParentBlock(e);if(0===n)return!0;var l=r.stepsToNearestParentOfAny(i);if(!(l>-1&&l<n))return!0;var o=r.getNearestParentOfAny(i);if(o.isBranchOfExhaustiveConditional()){var c,u=_createForOfIteratorHelper(o.getAlternateBranches());try{for(u.s();!(c=u.n()).done;){var _=c.value;if(!this.hasReturnInBlock(_))return!1}}catch(e){u.e(e)}finally{u.f()}return!0}}}catch(e){s.e(e)}finally{s.f()}return!1}},{key:"getFunctionCalls",value:function(){return _classPrivateFieldGet(this,_allFunctionCalls)}},{key:"getAggregateReturnType",value:function(){var e=this.getReturnTypes();return 0===e.length?(_classPrivateFieldSet(this,_aggReturnType,_expression.DataType.None),_expression.DataType.None):1===e.length?(_classPrivateFieldSet(this,_aggReturnType,e[0]),e[0]):_classPrivateMethodGet(this,_allReturnTypesNumeric,_allReturnTypesNumeric2).call(this)?_expression.DataType.Number:(_classPrivateFieldSet(this,_aggReturnType,_expression.DataType.Unknown),_expression.DataType.Unknown)}},{key:"toString",value:function(){return"Function name="+_classPrivateFieldGet(this,_name)+" block="+(void 0!==this.getBlock()?this.getBlock().getId():"unknown block")+" returns="+this.getReturnTypes().map((function(e){return e.name}))}},{key:"toJSON",value:function(){return{name:_classPrivateFieldGet(this,_name),block:this.getBlock().getId(),hasReturn:this.hasReturn(),returnTypes:this.getReturnTypes().map((function(e){return e.name})),returnDetail:this.getReturnDetail().map((function(e){return{line:e.line,dataType:e.dataType.name}})),hasBranchWithoutReturn:_classPrivateFieldGet(this,_hasBranchWithoutReturn),callLineNumbers:_classPrivateFieldGet(this,_allFunctionCalls).map((function(e){return e.getLineNumber()})),parameters:_classPrivateFieldGet(this,_parameters).map((function(e){return e.getName()})),numOptionalParameters:_classPrivateFieldGet(this,_optionalCount)}}}]),i}();function _allReturnTypesNumeric2(){var e,t=new Set(this.getReturnTypes()),i=_createForOfIteratorHelper(t);try{for(i.s();!(e=i.n()).done;){var a=e.value;if(a!==_expression.DataType.Int&&a!==_expression.DataType.Float&&a!==_expression.DataType.Number)return!1}}catch(e){i.e(e)}finally{i.f()}return t.size>0}exports.UserDefinedFunction=UserDefinedFunction;var _index=new WeakMap,_lineNumber=new WeakMap,FunctionUsage=function(){function e(t,i){_classCallCheck(this,e),_classPrivateFieldInitSpec(this,_index,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_lineNumber,{writable:!0,value:void 0}),_classPrivateFieldSet(this,_lineNumber,t),_classPrivateFieldSet(this,_index,i)}return _createClass(e,[{key:"getLineNumber",value:function(){return _classPrivateFieldGet(this,_lineNumber)}},{key:"getIndex",value:function(){return _classPrivateFieldGet(this,_index)}}]),e}();exports.FunctionUsage=FunctionUsage;var _name2=new WeakMap,_usages=new WeakMap,_definedInBlock=new WeakMap,_scope=new WeakMap,_isParameter=new WeakMap,_isImport=new WeakMap,_usedInFString=new WeakMap,_getLastUsageBlocks=new WeakSet,_checkForNestedExhaustiveConditionals=new WeakSet,_treeIsExhaustive=new WeakSet,_getBlocksAsTree=new WeakSet,_allUsagesAreInChildBlocks=new WeakSet,_usageInSameBlockAsLastAdded=new WeakSet,_usageInValidBlock=new WeakSet,_usageIsInConditionalStem=new WeakSet,_usageBlock=new WeakSet,_isInSameOrParent=new WeakSet,Variable=function(){function e(t,i,a,s,r){var n=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_isInSameOrParent),_classPrivateMethodInitSpec(this,_usageBlock),_classPrivateMethodInitSpec(this,_usageIsInConditionalStem),_classPrivateMethodInitSpec(this,_usageInValidBlock),_classPrivateMethodInitSpec(this,_usageInSameBlockAsLastAdded),_classPrivateMethodInitSpec(this,_allUsagesAreInChildBlocks),_classPrivateMethodInitSpec(this,_getBlocksAsTree),_classPrivateMethodInitSpec(this,_treeIsExhaustive),_classPrivateMethodInitSpec(this,_checkForNestedExhaustiveConditionals),_classPrivateMethodInitSpec(this,_getLastUsageBlocks),_classPrivateFieldInitSpec(this,_name2,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_usages,{writable:!0,value:[]}),_classPrivateFieldInitSpec(this,_definedInBlock,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_scope,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_isParameter,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_isImport,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_usedInFString,{writable:!0,value:!1}),_classPrivateFieldSet(this,_name2,t),_classPrivateFieldSet(this,_definedInBlock,r),_classPrivateFieldSet(this,_scope,r.getScope()),_classPrivateFieldSet(this,_isParameter,n),_classPrivateFieldSet(this,_isImport,l),n){var o=new VariableUsage(a,i,s,_expression.DataType.Unknown);_classPrivateFieldGet(this,_usages).push(o)}}return _createClass(e,[{key:"getName",value:function(){return _classPrivateFieldGet(this,_name2)}},{key:"addUsage",value:function(e){var t=this.getLastUsage();t&&t.getValueIsAssigned()&&(t.getExecutionLineNumber()>=0&&t.getExecutionLineNumber()===e.getExecutionLineNumber()||t.getLineNumber()===e.getLineNumber())?_classPrivateFieldGet(this,_usages).splice(-1,0,e):_classPrivateFieldGet(this,_usages).push(e)}},{key:"isUsed",value:function(){return _classPrivateFieldGet(this,_usages).length>1||_classPrivateFieldGet(this,_usedInFString)}},{key:"getUsages",value:function(){return _classPrivateFieldGet(this,_usages)}},{key:"getFirstUsage",value:function(){if(_classPrivateFieldGet(this,_usages).length>0)return _classPrivateFieldGet(this,_usages)[0]}},{key:"hasMatchingUsage",value:function(e){var t,i=_createForOfIteratorHelper(_classPrivateFieldGet(this,_usages));try{for(i.s();!(t=i.n()).done;){if(t.value.getLineNumber()===e)return!0}}catch(e){i.e(e)}finally{i.f()}return!1}},{key:"getLastUsage",value:function(){if(_classPrivateFieldGet(this,_usages).length>0)return _classPrivateFieldGet(this,_usages)[_classPrivateFieldGet(this,_usages).length-1]}},{key:"getLastUsageBefore",value:function(e,t){var i=this,a=[],s=_classPrivateFieldGet(this,_usages).length-1,r=e.getExecutionLineNumber();if(r<0||t[r].isVariableAssigned(e))return a;for(var n=_classPrivateMethodGet(this,_usageBlock,_usageBlock2).call(this,e,t),l=function(){var r=_classPrivateFieldGet(i,_usages)[s],l=r.getExecutionLineNumber(),o=_classPrivateMethodGet(i,_usageBlock,_usageBlock2).call(i,r,t);if(l>=0){if(e.getExecutionLineNumber()===r.getExecutionLineNumber()&&r.getValueIsAssigned()||_classPrivateMethodGet(i,_usageInSameBlockAsLastAdded,_usageInSameBlockAsLastAdded2).call(i,r,o,a,t))return s--,"continue";if(_classPrivateMethodGet(i,_isInSameOrParent,_isInSameOrParent2).call(i,e,n,r,o)){var c=a.length>0?_classPrivateMethodGet(i,_usageBlock,_usageBlock2).call(i,a[a.length-1],t):void 0;if(!(a.length>0&&c===o&&o.isBranchOfExhaustiveConditional()&&_classPrivateMethodGet(i,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(i,r,o)))return a.push(r),{v:a};var u=new Set(Array.from(o.getAlternateBranches()).filter((function(e){return e.getStartLine()>o.getStartLine()})));if(new Set(a.filter((function(e){var a=_classPrivateMethodGet(i,_usageBlock,_usageBlock2).call(i,e,t);return u.has(_classPrivateMethodGet(i,_usageBlock,_usageBlock2).call(i,e,t))&&!_classPrivateMethodGet(i,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(i,e,a)}))).size===u.size&&o.getBlockEntity()===_expression.ExpressionEntity.IfDefinition)return{v:a}}else if(!n.isInAlternateBranch(o)&&(a.push(r),o.getBlockEntity()===_expression.ExpressionEntity.IfDefinition&&o.isBranchOfExhaustiveConditional())){var _=o.getAlternateBranches();if(a.length-1<_.size)return"continue";if(new Set(a.filter((function(e){var a=_classPrivateMethodGet(i,_usageBlock,_usageBlock2).call(i,e,t);return _.has(_classPrivateMethodGet(i,_usageBlock,_usageBlock2).call(i,e,t))&&!_classPrivateMethodGet(i,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(i,e,a)}))).size===_.size){var d=o.getParentBlock(),h=void 0!==d?d.getNearestParentOfAny([_expression.ExpressionEntity.IfDefinition,_expression.ExpressionEntity.ElifDefinition,_expression.ExpressionEntity.ElseDefinition,_expression.ExpressionEntity.ForDefinition,_expression.ExpressionEntity.WhileDefinition]):void 0;if(void 0===h||h.hasChild(n))return{v:a}}}}s--};s>=0;){var o=l();if("continue"!==o&&"object"===_typeof(o))return o.v}if(_classPrivateMethodGet(this,_allUsagesAreInChildBlocks,_allUsagesAreInChildBlocks2).call(this,n,a,t)||a.length>0&&!_classPrivateMethodGet(this,_isInSameOrParent,_isInSameOrParent2).call(this,e,n,a[0],_classPrivateMethodGet(this,_usageBlock,_usageBlock2).call(this,a[0],t))){var c=_classPrivateMethodGet(this,_getLastUsageBlocks,_getLastUsageBlocks2).call(this,a,t);_classPrivateMethodGet(this,_checkForNestedExhaustiveConditionals,_checkForNestedExhaustiveConditionals2).call(this,n,c)||a.push(new VariableUsage(-1,-1,-1,_expression.DataType.Invalid))}return a}},{key:"updateTypeOfLastUsage",value:function(e){_classPrivateFieldGet(this,_usages).length>0&&_classPrivateFieldGet(this,_usages)[_classPrivateFieldGet(this,_usages).length-1].setType(e)}},{key:"getDefinedInBlock",value:function(){return _classPrivateFieldGet(this,_definedInBlock)}},{key:"getScope",value:function(){return _classPrivateFieldGet(this,_scope)}},{key:"isParameter",value:function(){return _classPrivateFieldGet(this,_isParameter)}},{key:"isImport",value:function(){return _classPrivateFieldGet(this,_isImport)}},{key:"setIsImport",value:function(){_classPrivateFieldSet(this,_isImport,!0)}},{key:"usedInFString",value:function(){_classPrivateFieldSet(this,_usedInFString,!0)}},{key:"toJSON",value:function(){return{name:_classPrivateFieldGet(this,_name2),definitionBlock:_classPrivateFieldGet(this,_definedInBlock).getId(),scopeBlock:_classPrivateFieldGet(this,_scope).getId(),isParameter:_classPrivateFieldGet(this,_isParameter),isImport:_classPrivateFieldGet(this,_isImport),usedInFString:_classPrivateFieldGet(this,_usedInFString),usages:_classPrivateFieldGet(this,_usages).map((function(e){return e.toJSON()}))}}}]),e}();function _getLastUsageBlocks2(e,t){var i,a=[],s=_createForOfIteratorHelper(e);try{for(s.s();!(i=s.n()).done;){var r=i.value,n=_classPrivateMethodGet(this,_usageBlock,_usageBlock2).call(this,r,t);_classPrivateMethodGet(this,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(this,r,n)&&(n=n.getParentBlock()),a.push(n)}}catch(e){s.e(e)}finally{s.f()}return a}function _checkForNestedExhaustiveConditionals2(e,t){var i=_classPrivateMethodGet(this,_getBlocksAsTree,_getBlocksAsTree2).call(this,t),a=_classPrivateMethodGet(this,_treeIsExhaustive,_treeIsExhaustive2).call(this,i);if(a){var s,r=_createForOfIteratorHelper(i);try{for(r.s();!(s=r.n()).done;){var n=s.value;if(n.block===e){a=!0;break}if(n.block.getStepsToParentBlock(e)>1){var l=n.block.getNearestParentOfAny([_expression.ExpressionEntity.ForDefinition,_expression.ExpressionEntity.WhileDefinition]);void 0!==l&&e.hasChild(l)&&(a=!1)}}}catch(e){r.e(e)}finally{r.f()}}return a}function _treeIsExhaustive2(e){var t=this;if(e.length<=1)return!1;for(var i=new Map,a=0;a<e.length;a++)i.has(e[a].stepsToDoc)||i.set(e[a].stepsToDoc,[]),i.get(e[a].stepsToDoc).push(e[a]);var s=Array.from(i.keys()).sort()[0],r=i.get(s);if(r[0].block.isBranchOfExhaustiveConditional()){var n,l=r[0].block.getAlternateBranches(),o=new Set,c=_createForOfIteratorHelper(l);try{for(c.s();!(n=c.n()).done;)for(var u=n.value,_=1;_<r.length;_++)r[_].block===u&&o.add(u)}catch(e){c.e(e)}finally{c.f()}if(o.size===l.size)return!0;if(i.size>1){i.delete(s);var d,h=_createForOfIteratorHelper(new Set(Array.from(l).filter((function(e){return!o.has(e)}))));try{var p=function(){var e=d.value,a=Array.from(i.entries()).flatMap((function(e){return e[1]})).filter((function(t){return e.hasChild(t.block)}));if(0===a.length||!_classPrivateMethodGet(t,_treeIsExhaustive,_treeIsExhaustive2).call(t,a))return{v:!1}};for(h.s();!(d=h.n()).done;){var v=p();if("object"===_typeof(v))return v.v}}catch(e){h.e(e)}finally{h.f()}return!0}}return!1}function _getBlocksAsTree2(e){for(var t=[],i=e.length-1;i>=0;i--){var a,s=e[i],r=new BlockNode(s,s.stepsToParentBlockOfEntity(_expression.ExpressionEntity.DocumentDefinition)),n=!1,l=_createForOfIteratorHelper(t);try{for(l.s();!(a=l.n()).done;){var o=a.value;if(o.hasChild(r)){n=o.addChild(r);break}}}catch(e){l.e(e)}finally{l.f()}n||t.push(r)}return t}function _allUsagesAreInChildBlocks2(e,t,i){var a,s=_createForOfIteratorHelper(t);try{for(s.s();!(a=s.n()).done;){var r=a.value,n=_classPrivateMethodGet(this,_usageBlock,_usageBlock2).call(this,r,i);if(!e.hasChild(n))return!1}}catch(e){s.e(e)}finally{s.f()}return t.length>0}function _usageInSameBlockAsLastAdded2(e,t,i,a){if(0===i.length||_classPrivateMethodGet(this,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(this,e,t))return!1;var s=i[i.length-1];return t===_classPrivateMethodGet(this,_usageBlock,_usageBlock2).call(this,s,a)}function _usageInValidBlock2(e,t){return e.getExecutionLineNumber()>=0&&e.getExecutionLineNumber()<t.length&&void 0!==t[e.getExecutionLineNumber()].getBlock()}function _usageIsInConditionalStem2(e,t){var i=t.getBlockEntity();return(i===_expression.ExpressionEntity.IfDefinition||i===_expression.ExpressionEntity.ElifDefinition)&&e.getLineNumber()===t.getStartLine()&&void 0!==t.getParentBlock()}function _usageBlock2(e,t){if(_classPrivateMethodGet(this,_usageInValidBlock,_usageInValidBlock2).call(this,e,t))return t[e.getExecutionLineNumber()].getBlock()}function _isInSameOrParent2(e,t,i,a){var s=_classPrivateMethodGet(this,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(this,e,t),r=_classPrivateMethodGet(this,_usageIsInConditionalStem,_usageIsInConditionalStem2).call(this,i,a);return!!(t===a||s&&t.getParentBlock()===a||s&&r&&t.getParentBlock()===a.getParentBlock()||r&&t===a.getParentBlock()||a.hasChild(t))}exports.Variable=Variable;var BlockNode=function(){function e(t,i){_classCallCheck(this,e),_defineProperty(this,"block",void 0),_defineProperty(this,"stepsToDoc",void 0),_defineProperty(this,"children",void 0),this.block=t,this.stepsToDoc=i,this.children=[]}return _createClass(e,[{key:"hasChild",value:function(e){return this.block!==e.block&&this.block.hasChild(e.block)}},{key:"addChild",value:function(e){var t=!1;if(this.hasChild(e)&&0===this.children.length)return this.children.push(e),!0;for(var i=0;i<this.children.length&&!t;)t=this.children[i].addChild(e),i++;return t}}]),e}(),_index2=new WeakMap,_lineNumber2=new WeakMap,_docIndex=new WeakMap,_dataType=new WeakMap,_valueSetOrUpdated=new WeakMap,_executionLineNumber=new WeakMap,_previouslyExecutedUsage=new WeakMap,_subscripted=new WeakMap,_aggregatePreviousTypes=new WeakSet,VariableUsage=function(e){_inherits(i,_observers.TypeChangeObserverNotifier);var t=_createSuper(i);function i(e,a,s){var r,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:_expression.DataType.NotParsed;return _classCallCheck(this,i),_classPrivateMethodInitSpec(_assertThisInitialized(r=t.call(this)),_aggregatePreviousTypes),_classPrivateFieldInitSpec(_assertThisInitialized(r),_index2,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_lineNumber2,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_docIndex,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_dataType,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_valueSetOrUpdated,{writable:!0,value:!1}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_executionLineNumber,{writable:!0,value:-1}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_previouslyExecutedUsage,{writable:!0,value:[]}),_classPrivateFieldInitSpec(_assertThisInitialized(r),_subscripted,{writable:!0,value:!1}),_classPrivateFieldSet(_assertThisInitialized(r),_index2,e),_classPrivateFieldSet(_assertThisInitialized(r),_lineNumber2,a),_classPrivateFieldSet(_assertThisInitialized(r),_docIndex,s),_classPrivateFieldSet(_assertThisInitialized(r),_dataType,n),r}return _createClass(i,[{key:"getIndex",value:function(){return _classPrivateFieldGet(this,_index2)}},{key:"getLineNumber",value:function(){return _classPrivateFieldGet(this,_lineNumber2)}},{key:"getDocIndex",value:function(){return _classPrivateFieldGet(this,_docIndex)}},{key:"setSubscripted",value:function(){_classPrivateFieldSet(this,_subscripted,!0)}},{key:"isSubscripted",value:function(){return _classPrivateFieldGet(this,_subscripted)}},{key:"setType",value:function(e){e!==_classPrivateFieldGet(this,_dataType)&&(_classPrivateFieldSet(this,_dataType,e),_get(_getPrototypeOf(i.prototype),"sendUpdate",this).call(this,e))}},{key:"typeUpdateReceived",value:function(e){e!==_classPrivateFieldGet(this,_dataType)&&(_classPrivateFieldGet(this,_previouslyExecutedUsage).length<=1?this.setType(e):this.setType(_classPrivateMethodGet(this,_aggregatePreviousTypes,_aggregatePreviousTypes2).call(this)))}},{key:"getType",value:function(){return _classPrivateFieldGet(this,_dataType)}},{key:"addPreviousUsage",value:function(e){_classPrivateFieldGet(this,_previouslyExecutedUsage).push(e),e.addObserver(this),this.setType(_classPrivateMethodGet(this,_aggregatePreviousTypes,_aggregatePreviousTypes2).call(this))}},{key:"addPreviousUsages",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;_classPrivateFieldGet(this,_previouslyExecutedUsage).push(a),a.addObserver(this)}}catch(e){i.e(e)}finally{i.f()}this.setType(_classPrivateMethodGet(this,_aggregatePreviousTypes,_aggregatePreviousTypes2).call(this))}},{key:"setValueIsAssigned",value:function(){_classPrivateFieldSet(this,_valueSetOrUpdated,!0)}},{key:"getValueIsAssigned",value:function(){return _classPrivateFieldGet(this,_valueSetOrUpdated)}},{key:"setExecutionLineNumber",value:function(e){_classPrivateFieldSet(this,_executionLineNumber,e)}},{key:"getExecutionLineNumber",value:function(){return _classPrivateFieldGet(this,_executionLineNumber)}},{key:"toString",value:function(){return"VariableUsage lineNum="+_classPrivateFieldGet(this,_lineNumber2)+" docIndex="+_classPrivateFieldGet(this,_docIndex)+" dataType="+_classPrivateFieldGet(this,_dataType).name}},{key:"toJSON",value:function(){return{line:_classPrivateFieldGet(this,_lineNumber2),docIndex:_classPrivateFieldGet(this,_docIndex),type:_classPrivateFieldGet(this,_dataType).name,subscripted:_classPrivateFieldGet(this,_subscripted)}}}]),i}();function _aggregatePreviousTypes2(){var e=Array.from(new Set(_classPrivateFieldGet(this,_previouslyExecutedUsage).map((function(e){return e.getType()}))));if(0===e.length)return _expression.DataType.Unknown;if(1===e.length)return e[0];var t,i=!0,a=_createForOfIteratorHelper(e);try{for(a.s();!(t=a.n()).done;){var s=t.value;if(s!==_expression.DataType.Int&&s!==_expression.DataType.Float&&s!==_expression.DataType.Number){i=!1;break}}}catch(e){a.e(e)}finally{a.f()}return i?_expression.DataType.Number:_expression.DataType.Unknown}exports.VariableUsage=VariableUsage;var _name3=new WeakMap,_entity=new WeakMap,_alias=new WeakMap,_directImports=new WeakMap,_importAll=new WeakMap,Module=function(){function e(t,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;_classCallCheck(this,e),_classPrivateFieldInitSpec(this,_name3,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_entity,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_alias,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_directImports,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_importAll,{writable:!0,value:void 0}),_classPrivateFieldSet(this,_name3,t),_classPrivateFieldSet(this,_entity,i),_classPrivateFieldSet(this,_alias,a),_classPrivateFieldSet(this,_directImports,new Map),_classPrivateFieldSet(this,_importAll,!1)}return _createClass(e,[{key:"getName",value:function(){return _classPrivateFieldGet(this,_name3)}},{key:"getEntity",value:function(){return _classPrivateFieldGet(this,_entity)}},{key:"getAlias",value:function(){return _classPrivateFieldGet(this,_alias)}},{key:"setAlias",value:function(e){_classPrivateFieldSet(this,_alias,e)}},{key:"addDirectImport",value:function(e,t){_classPrivateFieldGet(this,_directImports).set(e,t)}},{key:"hasDirectImport",value:function(e){return _classPrivateFieldGet(this,_directImports).has(e)}},{key:"getDirectImport",value:function(e){return _classPrivateFieldGet(this,_directImports).get(e)}},{key:"setImportAll",value:function(){_classPrivateFieldSet(this,_importAll,!0)}},{key:"didImportAll",value:function(){return _classPrivateFieldGet(this,_importAll)}},{key:"hasDirectImports",value:function(){return _classPrivateFieldGet(this,_importAll)||_classPrivateFieldGet(this,_directImports).size>0}}]),e}();exports.Module=Module;var directImport=function(e,t){return{entity:e,category:t}};exports.directImport=directImport;
